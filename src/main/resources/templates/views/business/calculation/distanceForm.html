<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content" data-menu="business-4-4">
    <div sec:authorize="isAuthenticated()">
        <div class="title">
            <h2>거리 증빙</h2>
        </div>
        
        <div class="tableLeftResponsive">
            <table class="tableLeft">
                <colgroup>
                    <col style="width: 200px">
                    <col style="width: auto">
                </colgroup>
                <tbody>
                    <tr>
                        <th scope="row">사업명</th>
                        <td th:text="${content[0].bizPbancMaster.bizPbancNm}">사업명</td>
                    </tr>
                    <tr>
                        <th scope="row">수행기관</th>
                        <td th:text="${content[0].bizOrganizationAply.organizationInfo.organizationName}">기관명</td>
                    </tr>
                    <tr>
                        <th scope="row">교육기간</th>
                        <td>
                            <span th:text="${content[0].bizPbancMaster.bizPbancRcptBgng}">2022-09-01</span> ~
                            <span th:text="${content[0].bizPbancMaster.bizPbancRcptEnd}">2022-11-10</span>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">강사명</th>
                        <td th:text="${content[0].instrNm}">강사명</td>
                    </tr>
                    <tr>
                        <th scope="row">출발지 명</th>
                        <td>
                            <div class="d-flex-2 hp_w400">
                                <input id='bizDistBgngNm' type="text" th:value="${content[0].bizDistBgngNm}" disabled>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">출발지 주소</th>
                        <td>
                            <input type="text" class="hp_w600" id="startAddr" th:value="${content[0].bizDistBgngAddr}" disabled>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">도착지 명</th>
                        <td th:text="${content[0].bizDistEndNm}">
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">도착지 주소</th>
                        <td>
                            <div>
                                <div class="d-flex-2" style="margin-bottom: 8px">
                                    <span id="bizDistEndAddr" th:text="${content[0].bizDistEndAddr}">경기도 남양주시 초등학교</span>
                                    <a target="_blank" th:href="@{https://map.kakao.com}" class="btn btnDefault btn_blue">지도보기</a>
                                </div>
                                <div id="endMap" style="width: 100%; height: 400px"></div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">강의료</th>
                        <td>
                            <div class="d-flex-2">
                                <span><span th:text="${content[0].bizPbancMaster.bizPbancYr}">2022</span>년 기준, <span th:text="${content[0].bizDistAmt}"></span>원</span>
                                <!-- 강사료 정산 - 이동거리 기준 단가 페이지 이동-->
                                <a href="/business/instructor/calculate/distance/amount" class="btn btnDefault">강사료 정보</a>
                            </div>
                            <div id="mapUpload" class="bl_uploadGrid mt-1">
                                <div class="bl_upload js_upload hp_lg_w462">
                                    <input id="dist_name" type="text" class="bl_upload_path js_path" readonly th:unless="${content.size > 0}">
                                    <input id="dist_name" type="text" class="bl_upload_path js_path" readonly th:if="${content.size > 0}" th:value="${content[0].bizDistMapFile != null ? content[0].bizDistMapFile : null}">
                                    <label for="dist_file" class="btn btnDefault bg-secondary text-white bl_upload_btn">파일선택</label>
                                    <input id="dist_file" type="file" name="file" class="bl_upload_file js_file">
                                </div>
                            </div>
                            <div class="chk_box mt-1">
                                <input id="mapChk" type="checkbox" name="mapChk" th:checked="${content[0].bizDistMapYn==1}">
                                <label for="mapChk">
                                    <span></span>
                                    40km 미만으로 지도 이미지를 첨부하지 않습니다.
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>거리</th>
                        <td >
                            <input class="hp_w120" type="text" id="bizDistValue" th:value="${content[0].bizDistValue}">
                            <p class="guide_text">숫자만 소수점 한자리까지 입력해 주세요. </p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>상태변경</th>
                        <td>
                            <select id="bizDistStts" class="common_select">
                                <option value="0" th:selected="${content[0].bizDistStts} == 0">확인전</option>
                                <option value="1" th:selected="${content[0].bizDistStts} == 1">확인완료</option>
                            </select>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bl_gridBtns">
            <div class="bl_gridBtns_rgt">
                <a href="/business/instructor/distance?bizDistStts=0" class="btn btnDefault btnList">목록</a>
                <a th:onclick="update()" class="btn btnDefault btnRegister">수정</a>
                <a th:unless="${content.size > 0 && content[0].bizDistStts == 0}" id="dist_delete" class="btn btnDefault btnDelete">삭제</a>
            </div>
        </div>
    </div>
    <div sec:authorize="!isAuthenticated()"></div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            $("#dist_file").bind("change", function (e){
                if( this.files[0].name){
                    $("#dist_name").val(this.files[0].name);
                }
            })

            function update(){
                let params = getFormData();
                if(parseFloat($("#bizDistValue").val())>=0){
                    $.ajax({
                        type: "put", //http method
                        url: `/api/business/instructor/distance/update`, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(params),
                        dataType: "json",
                        success: function(data) {
                            if($("#dist_file")[0].files.length==1){
                                let form = new FormData();
                                form.append( "attachFile", $("#dist_file")[0].files[0] );
                                $.ajax({
                                    type: "put", //http method
                                    url: `/api/business/instructor/distance/upload/${data.bizInstrDistNo}`, //값을 가져올 경로
                                    processData : false,
                                    contentType : false,
                                    data: form,
                                    success: function(data) {
                                        alert("수정이 완료되었습니다.");
                                        window.location.reload();
                                    },error:function (e){
                                        if(e && e.responseJSON && e.responseJSON.resultMessage){
                                            alert(e.responseJSON.resultMessage);
                                        }else{
                                            alert('수정하는 과정에서 오류가 발생했습니다.');
                                        }
                                    }
                                })
                            }else{
                                alert("수정이 완료되었습니다.");
                                window.location.reload();
                            }
                        },
                        error: function(e) {
                            if(e && e.responseJSON && e.responseJSON.resultMessage){
                                alert(e.responseJSON.resultMessage);
                            }else{
                                alert('수정하는 과정에서 오류가 발생했습니다.');
                            }
                        }
                    })
                }else{
                    alert('거리에는 0보다 크거나 같은 숫자만 입력해 주세요.')
                }
            }
            /* <![CDATA[ */
            function getFormData(){
                let CONT = [[ ${content} ]];
                let params = {};
                if($("#dist_name").val()){
                    params.bizDistMapYn = 0;
                }else{
                    params.bizDistMapYn = 1;
                }
                params.bizDistAmt = CONT[0].bizDistAmt;
                params.bizDistEndAddr = CONT[0].bizDistEndAddr;
                params.bizDistEndNm = CONT[0].bizDistEndNm;
                params.bizDistBgngAddr = $("#startAddr").val();
                params.bizDistBgngNm = $("#bizDistBgngNm").val();
                params.bizDistMapFile = CONT[0].bizDistMapFile;
                params.bizDistValue = parseFloat($("#bizDistValue").val());
                params.bizDistStts = $("#bizDistStts").val()
                params.bizInstrDistNo = CONT[0].bizInstrDistNo;
                params.bizInstrAplyNo = CONT[0].bizInstrAplyNo;
                params.bizOrgAplyNo = CONT[0].bizOrgAplyNo;
                if(AMT && AMT.content && AMT.content[0]){
                    let temp = parseFloat($("#bizDistValue").val());
                    for(let amtItem of AMT.content[0].bizInstructorDistCrtrAmtItems){
                        if(temp >= amtItem.bizInstrDistCrtrAmtItemLowr && temp < amtItem.bizInstrDistCrtrAmtItemUp ){
                            params.bizDistAmt = amtItem.bizInstrDistCrtrAmtItemValue;
                        }
                    }
                    if(params.bizDistAmt ==0){
                        params.bizDistAmt = AMT.content[0].bizInstrDistCrtrAmtValue
                    }
                }
                return params;
            }

            let AMT =  [[ ${clclDdlnAmt} ]];
            function onLoadSubmit() {
                console.log('commonCode: ', [[ ${commonCode} ]] )
                const CONT = [[ ${content} ]];
                makeMap(CONT[0].bizDistEndAddr);
                mapChk();
            }

            function findPoint(input,currentPage=1,countPerPage=10) {
                let result={};
                let newkey = "6046c13b83a2e4d21d510736715ad9eb";
                let url ="https://dapi.kakao.com/v2/local/search/address.json";
                $.ajax({
                    data: { query: input,page:currentPage,size:countPerPage },
                    url: url,
                    headers : {
                        "Content-Type" : "application/json",
                        Authorization : "KakaoAK "+newkey
                    },
                    async: false,
                    dataType: "json",
                    method: "GET",
                    error: function (e) {
                        result.documents=false
                    },
                    success: function (data) {
                        result = data;
                    },
                })
                if(result.documents && result.documents.length>0)
                    return result.documents[0];
                else
                    return null;
            }
            function makeMap(index){
                let data = findPoint(index);
                var mapContainer = document.getElementById('endMap'), // 지도를 표시할 div
                    mapOption = {
                        center: new kakao.maps.LatLng(data.y, data.x), // 지도의 중심좌표
                        draggable: false, // 지도를 생성할때 지도 이동 및 확대/축소를 막으려면 draggable: false 옵션을 추가하세요
                        level: 3 // 지도의 확대 레벨
                    };
                // 지도를 생성합니다
                var map = new kakao.maps.Map(mapContainer, mapOption);
                // 주소-좌표 변환 객체를 생성합니다
                var geocoder = new kakao.maps.services.Geocoder();
                // 주소로 좌표를 검색합니다
                geocoder.addressSearch(index, function(result, status) {
                    // 정상적으로 검색이 완료됐으면
                    if (status === kakao.maps.services.Status.OK) {
                        var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                        // 결과값으로 받은 위치를 마커로 표시합니다
                        var marker = new kakao.maps.Marker({
                            map: map,
                            position: coords
                        });
                        map.setCenter(coords);
                    }
                });
            }

            //강의료 지도 이미지 첨부 체크
            function mapChk() {
                if ($('#mapChk').is(':checked')) {
                    $('#mapUpload').hide();
                } else {
                    $('#mapUpload').show();
                }
            }
            mapChk();
            $('#mapChk').change(mapChk);
            /* ]]> */

            //주소 string으로 거리를 계산하는 함수
            function getDistance(start, end){
                let startPoint = findPoint(start);
                let endPoint= findPoint(end);
                if(startPoint && endPoint){
                    let len = distance(startPoint.y,startPoint.x,endPoint.y, endPoint.x)
                    len = Math.round(len * 10)/10;
                    $("#bizDistValue").val(len);
                }else if(startPoint == null){
                    alert("출발지 주소를 검색하는 과정에서 오류가 발생했습니다.")
                }else if(endPoint == null){
                    alert("기관 주소를 검색하는 과정에서 오류가 발생했습니다.")
                }

            }


            //시작Y, 시작X, 도착Y, 도착X 좌표를 입력하면 추천경로 계산
            function distance(lat1,lng1,lat2,lng2){
                let result=0;
                let newkey = "6046c13b83a2e4d21d510736715ad9eb";
                let url =`https://apis-navi.kakaomobility.com/v1/directions?origin=${lng1},${lat1}&destination=${lng2},${lat2}&summary=true`;
                $.ajax({
                    url: url,
                    headers : {
                        "Content-Type" : "application/json",
                        Authorization : "KakaoAK "+newkey
                    },
                    async: false,
                    dataType: "json",
                    method: "GET",
                    error: function (e) {
                        result=0
                    },
                    success: function (data) {
                        result = data.routes[0].summary.distance/1000
                    },
                })
                return result;
            }

            $("#dist_delete").bind("click", function (e){
                if (confirm("정말로 삭제하시겠습니까? 거리증빙 기록이 존재하지 않으면 강사료 정산(강의확인서 등) 시에 오류가 발생합니다.")) {
                    let params = getFormData();
                    $.ajax({
                        type: "delete", //http method
                        url: `/api/business/instructor/distance/delete/${params.bizInstrDistNo}`, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(params),
                        dataType: "json",
                        success: function(data) {
                            alert("삭제가 완료되었습니다.");
                        },
                        error: function(e) { }
                    })
                }
            })
        </script>
    </th:block>
</div>
</body>
</html>