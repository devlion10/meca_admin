<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/pop_layout}">
<body class="reduction">
<div layout:fragment="pop">
  <style>
    @media print {
      header, footer, .no-print { display:none }
    }
    .reduction {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .reduction #__certi__ {
      transform: scale(0.29) translate(-123%, -123%);
    }
    #__certi__ {
      font-family: 'ChosunGs';
    }
    #__certi__ .certi_wrap {
      position: absolute;
      top: 863px;
      left: 359px;
      width: 1715px;
    }
    #__certi__ .user_info {
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }
    #__certi__ .user_company {
      font-size: 45px;
      letter-spacing: 6px;
    }
    #__certi__ .user_name {
      font-size: 86px;
      margin-left: 69px;
      letter-spacing: 18px;
    }
    #__certi__ .curriculum_info {
      margin-top: 180px;
    }
    #__certi__ .curriculum_info > div {
      display: flex;
      font-size: 51px;
      line-height: 1.4;
      letter-spacing: 10px;
    }
    #__certi__ .curriculum_info > div + div {
      margin-top: 46px;
    }
    #__certi__ .curriculum_info .tit {
      position: relative;
      width: 282px;
      margin-right: 30px;
      flex-shrink: 0;
    }
    #__certi__ .curriculum_info .tit:after {
      content: ':';
      position: absolute;
      right: 0;
      letter-spacing: 10px;
    }
    #__certi__ .certi_content {
      position: relative;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      width: 100%;
      height: 900px;
      font-size: 69px;
      line-height: 130px;
      letter-spacing: 5px;
      clear: both;
      text-align: center;
    }
    #__certi__ .certi_content>div {
      width: 100%;
    }
    #__certi__ .certi_date {
      text-align: center;
      font-size: 57px;
      letter-spacing: 4px;
    }
    #__certi__ .certi_bot {
      text-align: center;
      font-size: 86px;
      font-weight: 700;
      margin-top: 150px;
    }
    .certi_btns {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
    }
    #pdfDownBtn {
      font-size: 15px!important;
      height: 120px;
      line-height: 120px;
      margin-right: 5px;
    }
    #printBtn {
      font-size: 15px!important;
      height: 120px;
      line-height: 120px;
    }
  </style>
  <div class="certi_btns">
    <span id="pdfDownBtn" class="btn_type1 btn_lg btn_red" onclick="pdfDown()">pdf 다운로드</span>
    <span id="printBtn" class="btn_type1 btn_lg btn_blue" onclick="certiPrint()">인쇄</span>
  </div>
  <div id="__certi__" class="eLearning">
    <div class="certi_wrap">
      <div class="user_info">
        <div class="user_company">(주)매일신문사</div>
        <div class="user_name">박상현</div>
      </div>

      <div class="curriculum_info">
        <div class="curriculum_name">
          <span class="tit" style="letter-spacing: 38px">과정명</span>
          <span class="value">제 334기 수습기자 기본교육</span>
        </div>
        <div class="curriculum_date">
          <span class="tit">학습기간</span>
          <div class="value">
            <span class="curriculum_sdate">2023년 01월 09일</span> ~
            <span class="curriculum_edate">2023년 01월 20일</span>
          </div>
        </div>
        <div class="curriculum_time">
          <span class="tit">학습시간</span>
          <span class="value">5시간</span>
        </div>
      </div>

      <div class="certi_content">
        <div>
          상기인은 한국언론진흥재단이 주관하는<br>
          &#8216;<span>제 334기 수습기자 기본교육</span>&#8217;<br>
          과정을 성실히 이수하였기에 이 증서를 드립니다.
        </div>
      </div>

      <div class="certi_date">2023년 02월 02일</div>
      <div class="certi_bot">한국언론진흥재단 이사장</div>
    </div>
  </div>
  <th:block layout:fragment="script">
    <script th:inline="javascript">
      /* <![CDATA[ */
      let fileName;

      function dateConvert(date){
        let convertDate = date.substring(0,4)+'년 '+ date.substring(5,7)+'월 ' + date.substring(8,10)+'일';
        return convertDate
      }

      function makeCerti(){
        const data = window.sendData;
        if(data){
          fileName = '수료증_' + data.eduTitle + '_' +data.name;
          document.querySelector('#__certi__ .user_company').innerText = data.organName;
          document.querySelector('#__certi__ .user_name').innerText = data.name;
          document.querySelector('#__certi__ .curriculum_name .value').innerText = data.eduTitle;
          document.querySelector('#__certi__ .curriculum_sdate').innerText = dateConvert(data.eduStartDate);
          if(data.eduEndDate !== null){
            document.querySelector('#__certi__ .curriculum_edate').innerText = dateConvert(data.eduEndDate);
          } else {
            document.querySelector('#__certi__ .curriculum_edate').innerText = dateConvert(data.eduCompleteDate);
          }
          document.querySelector('#__certi__ .certi_content div span').innerText = data.eduTitle;
          document.querySelector('#__certi__ .curriculum_time .value').innerText = data.eduTime;
          /* 수료증 하단 날짜 */
          let today = new Date();
          let year = today.getFullYear(); // 년도
          let month = today.getMonth() + 1;  // 월
          let date = today.getDate();  // 날짜

          let fullMonth
          if (month < 10)
            fullMonth = "0"+month
          else
            fullMonth = month
          let fullDate
          if (date < 10)
            fullDate = "0"+date
          else
            fullDate = date

          document.querySelector('#__certi__ .certi_date').innerText = year+'년 '+fullMonth+'월 '+fullDate+'일';
        }else{
          alert('오류가 발생했습니다.');
          window.close();
        }
      }

      function pdfDown(){
        $('.reduction').append('<div class="dimm"></div>');
        $('.reduction').removeClass('reduction');
        html2canvas(document.querySelector('#__certi__')).then(canvas => {
          // 캔버스를 이미지로 변환
          var imgData = canvas.toDataURL('image/png');

          var imgWidth = 190; // 이미지 가로 길이(mm) / A4 기준 210mm
          var pageHeight = imgWidth * 1.414;  // 출력 페이지 세로 길이 계산 A4 기준
          var imgHeight = canvas.height * imgWidth / canvas.width;
          var heightLeft = imgHeight;
          var margin = 10; // 출력 페이지 여백설정
          var doc = new jsPDF('p','mm','a4');
          var position = 0;

          var width = doc.internal.pageSize.getWidth();
          var height = doc.internal.pageSize.getHeight();
          doc.addImage(imgData, 'PNG', 0, 11, width, height);
          doc.save(fileName+'.pdf');
          window.close();
        })
      }

      function certiPrint() {
        var certi = document.querySelector('#__certi__')
        var certi_btns = document.querySelector('.certi_btns')
        var certiDiv = document.createElement('div')
        certiDiv.setAttribute('id', 'certiDiv')
        certiDiv.setAttribute('class', 'eLearning')

        html2canvas(certi).then(canvas => {
          certiDiv.append(canvas)
          certi.parentElement.append(certiDiv)
          $(certi).hide()
          $(certi_btns).hide()
        }).then(function () {
          window.print();
          $(certi).show()
          $(certi_btns).show()
          $(certiDiv).remove()
        })
      }

      function onLoadSubmit() {
        makeCerti();
      }
      /* ]]> */
    </script>
  </th:block>
</div>
</body>
</html>