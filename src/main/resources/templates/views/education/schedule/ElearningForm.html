<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content" data-menu="edu-2">
    <div sec:authorize="isAuthenticated()">
        <div class="title">
            <h2>과정개설 관리</h2>
        </div>

        <div class="tableLeftResponsive">
            <table class="tableLeft">
                <colgroup>
                    <col style="width: 200px">
                    <col style="width: auto">
                </colgroup>
                <tbody>
                    <tr>
                        <th scope="row">유형</th>
                        <td>
                            <div class="radio_box">
                                <input id="type4" type="radio" name="type" value="4">
                                <label for="type4">
                                    <a href="/education/schedule/regist/parallel" class="d-flex-start">
                                        <span></span>
                                        병행(화상+집합)
                                    </a>
                                </label>
                            </div>
                            <div class="radio_box">
                                <input id="type1" type="radio" name="type" value="2">
                                <label for="type1">
                                    <a href="/education/schedule/regist/lecture" class="d-flex-start">
                                        <span></span>
                                        집합
                                    </a>
                                </label>
                            </div>
                            <div class="radio_box">
                                <input id="type2" type="radio" name="type" value="1">
                                <label for="type2">
                                    <a href="/education/schedule/regist/e-lecture" class="d-flex-start">
                                        <span></span>
                                        화상
                                    </a>
                                </label>
                            </div>
                            <div class="radio_box">
                                <input id="type3" type="radio" name="type" value="3" checked>
                                <label for="type3">
                                    <a href="/education/schedule/regist/e-learning" class="d-flex-start">
                                        <span></span>
                                        이러닝
                                    </a>
                                </label>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="tableLeftResponsive" th:with="data=${content.size > 0 ? content[0] : null}">
            <table class="tableLeft">
                <colgroup>
                    <col style="width: 200px">
                    <col style="width: auto">
                    <col style="width: 200px">
                    <col style="width: auto">
                </colgroup>
                <tbody>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>과정선택</th>
                        <td colspan="3">
                            <div class="d-flex-2">
                                <input type="text" class="hp_w600" name="curriculumName"
                                       th:id="${content.size > 0 ? content[0].curriculumMaster.curriculumCode : null}"
                                       th:value="${content.size > 0 ? content[0].curriculumMaster.curriculumName : null}" readonly>
                                <div data-control="modal" data-handler="modalOfCurriculum" class="btn btnDefault" onclick="goCurriculumSearch()">과정 선택</div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>담당자</th>
                        <td>
                            <input type="text" class="hp_w200" name="eduPlanPic" data-key="eduPlanPic" th:value="${data?.curriculumMaster?.managerDepartment}" readonly>
                            <input type="hidden" class="hp_w200" id="province" name="province" data-key="province" th:value="${data?.province}" readonly>
                            <button type="button" onclick="findAdminTel()" class="btn btnDefault">연락처 확인</button>
                        </td>
                        <th scope="row">담당자 연락처</th>
                        <td>
                            <input type="text" class="hp_w400" id="picTel" name="picTel" data-key="picTel" th:value="${data?.picTel}" readonly/>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>운영형태</th>
                        <td colspan="3">
                            <select class="common_select" id="operation">
                                <th:block th:each="commonCode : ${commonCode}" th:if="${commonCode.code} == 'OPER_TYPE'">
                                    <option th:each="operationType : ${commonCode.subCode}" th:value="${operationType.code}"
                                            th:text="${operationType.codeName}"
                                            th:selected="${content.size > 0 ? content[0].operationType == operationType.code : false}"></option>
                                </th:block>
                            </select>
                        </td>
                    </tr>
                    <tr class="operation_view">
                        <th scope="row"><span class="el_required">*</span>연도</th>
                        <td>
                            <select class="common_select" data-list="yearList" id="yearOfEducationPlan"></select>
                        </td>
                        <th scope="row"><span class="el_required">*</span>기수</th>
                        <td>
                            <select class="common_select" data-list="numList2" id="yearOfEducationPlanStep"></select>
                        </td>
                    </tr>
                  
                    <tr class="operation_view">
                        <th scope="row"><span class="el_required">*</span>신청기간</th>
                        <td colspan="3">
                            <div class="bl_dateRange hp_wAuto">
                                <input type="text" class="el_datePicker hp_w200 sdate" id="applyBeginDate">
                                <span class="blank">~</span>
                                <input type="text" class="el_datePicker hp_w200 edate" id="applyEndDate">
                            </div>
                        </td>
                    </tr>
                    <tr class="operation_view">
                        <th scope="row"><span class="el_required">*</span>취소기간</th>
                        <td colspan="3">
                            <div class="bl_dateRange hp_wAuto">
                                <input type="text" class="el_datePicker hp_w200 sdate" id="cancelBeginDate">
                                <span class="blank">~</span>
                                <input type="text" class="el_datePicker hp_w200 edate" id="cancelEndDate">
                            </div>
                        </td>
                    </tr>
                    <tr class="operation_view">
                        <th scope="row"><span class="el_required">*</span>교육기간</th>
                        <td colspan="3">
                            <div class="bl_dateRange hp_wAuto">
                                <div class="d-flex-1">
                                    <input type="text" class="el_datePicker hp_w200 sdate" id="operationBeginDate">
                                    <select class="common_select" data-list="hourList" id="operationBeginHour"></select>
                                    <select class="common_select" data-list="minuteList" id="operationBeginMinute"></select>
                                </div>
                                <span class="blank">~</span>
                                <div class="d-flex-1">
                                    <input type="text" class="el_datePicker hp_w200 edate" id="operationEndDate">
                                    <select class="common_select" data-list="hourList" id="operationEndHour"></select>
                                    <select class="common_select" data-list="minuteList" id="operationEndMinute"></select>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr class="operation_view2">
                        <th scope="row"><span class="el_required">*</span>수강기한</th>
                        <td colspan="3">
                            <div class="d-flex-2">
                                수강 승인 후
                                <input type="text" class="hp_w80" id="alwaysEducationTerm" th:value="${content.size > 0 ? content[0].alwaysEducationTerm : null}">
                                일 까지 수료 가능
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>썸네일</th>
                        <td colspan="3">
                            <div class="bl_uploadGrid">
                                <div class="bl_upload">
                                    <input th:value="${data?.thumbnailFilePath}" id="thumbnailFileName" type="text" class="bl_upload_path js_path" readonly>
                                    <label for="thumbnailFile" class="btn btnDefault bg-secondary text-white bl_upload_btn">파일선택</label>
                                    <input id="thumbnailFile" type="file" name="thumbnailFile" class="bl_upload_file js_file">
                                </div>
                                <a th:value="${data?.educationPlanCode}" class="btn btnDefault bl_uploadGrid2_del">파일삭제</a>
                                <a id="thumbnailDownload" th:if="${data?.thumbnailFilePath != null}" th:href="@{/api/common/upload/download(attachFilePath = ${data.thumbnailFilePath})}" class="btn btnDefault bg_blue download_ajax ms-1">다운로드</a>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>상태</th>
                        <td>
                            <select class="common_select" id="isUsable">
                                <option value="true" th:unless="${content.size > 0}">사용</option>
                                <option value="false" th:unless="${content.size > 0}">미사용</option>
                                <option value="true" th:if="${content.size > 0}" th:selected="${content[0].isUsable == true}">사용</option>
                                <option value="false" th:if="${content.size > 0}" th:selected="${content[0].isUsable == false}">미사용</option>
                            </select>
                        </td>
                        <th scope="row"><span class="el_required">*</span>상단고정</th>
                        <td>
                            <div class="radio_box">
                                <input id="is_top_y" type="radio" name="isTop" value="true" th:if="${content.size > 0}" th:checked="${content[0].isTop}">
                                <input id="is_top_y" type="radio" name="isTop" value="true" th:unless="${content.size > 0}">
                                <label for="is_top_y">
                                    <span></span>
                                    Y
                                </label>
                            </div>
                            <div class="radio_box">
                                <input id="is_top_n" type="radio" name="isTop" value="false" th:if="${content.size > 0}" th:checked="${!content[0].isTop}">
                                <input id="is_top_n" type="radio" name="isTop" value="false" th:unless="${content.size > 0}" checked>
                                <label for="is_top_n">
                                    <span></span>
                                    N
                                </label>
                            </div>
                        </td>
                    </tr>
                    <tr> <!-- 파일첨부 API 5 -->
                        <th scope="row">파일첨부</th>
                        <td colspan="3">
                            <div class="bl_uploadList__scroll hp_w600">
                                <ul class="bl_uploadList" th:if="${(content != null) && (content.size > 0) && (content[0].fileMasters != null)}">
                                    <li th:each="item, index: ${content[0].fileMasters}">
                                        <a th:href="@{/api/common/upload/download(attachFilePath=${item.filePath})}" class="download_ajax" th:text="${item.originalFileName}"></a>
                                        <div class="bl_uploadList_rgt">
                                            <span class="file_size" th:text="${item.fileSize}"></span>
                                            <a class="file_delete" th:href="@{/api/common/upload/delete/{sn}(sn=${item.fileSn})}" th:value="${index.index}">
                                                <i class="fas fa-times color_red"></i>
                                            </a>
                                        </div>
                                    </li>
                                </ul>
                                <ul class="bl_uploadList" th:unless="${(content != null) && (content.size > 0) && (content[0].fileMasters != null)}"></ul>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2 hp_w600">
                                <div class="d-flex gap-2 align-items-center">
                                    <div class="bl_uploadGrid">
                                        <div class="bl_upload js_upload me-0">
                                            <label for="formFile" class="btn btnDefault bg-secondary text-white bl_upload_btn">파일찾기</label>
                                            <input id="formFile" type="file" name="formFile" class="bl_upload_file js_file" accept=".gif, .jpg, .png, .pdf, .hwp, .hwpx, .doc, .docx, .ppt, .pptx, .xls, .xlsx, .zip">
                                        </div>
                                    </div>
                                    <p class="bl_uploadNote">※ 파일형식 gif, jpg, png, pdf, hwp, doc, docx, ppt, pptx, xls, xlsx, zip / 5MB 미만</p>
                                </div>
                                <p id="fileSize" class="bl_uploadNote">총용량: <span id="fileMB">0</span>MB</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bl_gridBtns">
            <div class="bl_gridBtns_rgt">
                <a href="/education/schedule" class="btn btnDefault btnList">목록</a>
                <a th:if="${content.size > 0}" name="button" class="btn btnDefault btnRegister" onclick="modify()">수정</a>
                <a th:unless="${content.size > 0}" name="button" class="btn btnDefault btnRegister" onclick="regist()">등록</a>
            </div>
        </div>
        <input id="video_lecture_y" type="radio" data-key="isVideoLecture" name="isVideoLecture" value="false" checked style="display:none;"/>
    </div>
    <div sec:authorize="!isAuthenticated()"></div>

    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /* <![CDATA[ */
            //썸네일 파일 이름 input 적용
            $("#thumbnailFile").bind('change', function (e){
                if( $("#thumbnailFile")[0].files[0].name){
                    $("#thumbnailFileName").val($("[name=thumbnailFile]")[0].files[0].name);
                }
            })
            //썸네일 삭제 이벤트
            $(".bl_uploadGrid2_del").bind('click', function (e){
                if($("#thumbnailFileName").val() && confirm("정말로 썸네일 파일을 삭제하시겠습니까?")){
                    let eduPlanCode = $(".bl_uploadGrid2_del").attr("value");
                    $.ajax({
                        type: "delete", //http method
                        url: `/api/education/schedule/delete/thumbnailFile/${eduPlanCode}`,
                        headers: {'Content-Type': 'application/json'},
                        dataType: "json",
                        success: function(data) {
                            alert("삭제되었습니다.");
                            $("#thumbnailFileName").val(null);
                            $("#thumbnailDownload").remove();
                        },
                        error: function(data) {
                            alert("오류가 발생했습니다.")
                        }
                    })
                }else if($("#thumbnailFileName").val()==''){
                    alert('등록된 파일이 없습니다.')
                }
            })

            const commonCode = [[ ${commonCode} ]];
            const params = {};
            let content = [[ ${content} ]];

            function onLoadSubmit() {
                console.log('commonCode: ', [[ ${commonCode} ]] )

                //총용량 계산1
                $(".file_size").each((index, item)=>{
                    let text = $(item).text();
                    if(text.indexOf('KB')==-1){
                        text = text.replace("MB", "");
                        text = parseFloat(text)
                    }else{
                        text = text.replace("KB", "");
                        text = parseFloat(text) / 1024;
                        text = text.toFixed(2);
                    }
                    let now = $('#fileMB').text();
                    now = parseFloat(now)+parseFloat(text);
                    now = parseFloat(now).toFixed(2);
                    $('#fileMB').text(now);
                })

                if(content && content.length){
                    content = content[0];
                    /** 연도 셋팅 */
                    if(content.yearOfEducationPlan) { document.querySelector('#yearOfEducationPlan').value = content.yearOfEducationPlan; }
                    /** 기수 셋팅 */
                    if(content.yearOfEducationPlanStep) { document.querySelector("#yearOfEducationPlanStep").value = content.yearOfEducationPlanStep; }
                    /** 신청기간 셋팅 */
                    if(content.applyBeginDateTime && content.applyEndDateTime) {
                        document.querySelector("#applyBeginDate").value = content.applyBeginDateTime.substring(0, 10);
                        document.querySelector("#applyEndDate").value = content.applyEndDateTime.substring(0, 10);
                    }
                    /** 취소기간 셋팅 */
                    if(content.cancelBeginDateTime && content.cancelEndDateTime) {
                        document.querySelector("#cancelBeginDate").value = content.cancelBeginDateTime.substring(0, 10);
                        document.querySelector("#cancelEndDate").value = content.cancelEndDateTime.substring(0, 10);
                    }
                    /** 교육기간 셋팅 */
                    if(content.operationBeginDateTime && content.operationEndDateTime) {
                        document.querySelector("#operationBeginDate").value = content.operationBeginDateTime.substring(0, 10);
                        document.querySelector("#operationBeginHour").value = content.operationBeginDateTime.substring(11, 13);
                        document.querySelector("#operationBeginMinute").value = content.operationBeginDateTime.substring(14, 16);
                        document.querySelector("#operationEndDate").value = content.operationEndDateTime.substring(0, 10);
                        document.querySelector("#operationEndHour").value = content.operationEndDateTime.substring(11, 13);
                        document.querySelector("#operationEndMinute").value = content.operationEndDateTime.substring(14, 16);
                    }
                }
            }

            // 운영형태에 따라 세팅 항목 다르게 노출
            function operationView() {
                let operationVal = $('#operation option:selected').text();
                if (operationVal == '기수운영') {
                    $('.operation_view').css('display', 'table-row');
                    $('.operation_view2').css('display', 'none');
                } else if (operationVal == '상시운영') {
                    $('.operation_view').css('display', 'none');
                    $('.operation_view2').css('display', 'table-row');
                }
            }
            operationView();
            $('#operation').change(function(){
                operationView();
            })

            let contentsData = [];
            async function goCurriculumSearch(){
                let item = await searchCurriculum(3, true, [[${commonCode}]] );
                if( item ){
                    $("input[name=curriculumName]")[0].value = item.curriculumName;
                    $("input[name=curriculumName]")[0].id = item.curriculumCode;
                    $("input[name=eduPlanPic]")[0].value = item.managerDepartment;
                }
            }

            // 미입력된 필수 정보가 있을 경우 alert
            function requiredChk() {
                if (!$("input[name=isVideoLecture]")[0].id) {
                    alert('화상 강의 여부는 필수입니다.');
                    return false;
                } else params.isVideoLecture = $("input[type=radio][name=isVideoLecture]").filter(":checked")[0].value;

                if (!$("input[name=curriculumName]")[0].id) {
                    alert('교육 과정은 필수입니다.');
                    return false;
                } else params.curriculumCode = $("input[name=curriculumName]")[0].value;

                if (!document.querySelector("#operation").value) {
                    alert('운영타입은 필수입니다.');
                    return false;
                } else params.operationType = document.querySelector("#operation").value;

                /** 담당자 정보 */
                if($("input[name=eduPlanPic]").val()) {
                    params.eduPlanPic = $("input[name=eduPlanPic]").val();
                } else {
                    alert('담당자 정보는 필수입니다.'); return false;
                }

                /** 썸네일 파일 */
                if(document.querySelector('#thumbnailFileName').value
                    || document.querySelector('#thumbnailFile').value) {
                } else {
                    alert('썸네일 파일은 필수입니다.'); return false;
                }

                switch (document.querySelector("#operation").value) {
                    case "1": /** 기수 운영 */
                        if (!document.querySelector("#operationBeginDate").value || !document.querySelector("#operationEndDate").value) {
                            alert('운영일자는 필수입니다.');
                            return false;
                        } else {
                            params.operationBeginDateTime = document.querySelector("#operationBeginDate").value.replaceAll(".","-") + " "
                                + String(document.querySelector("#operationBeginHour").value == "24" ? "00" : document.querySelector("#operationBeginHour").value).padStart(2, "0")
                                + ":" + String(document.querySelector("#operationBeginMinute").value).padStart(2, "0") + ":00";
                            params.operationEndDateTime = document.querySelector("#operationEndDate").value.replaceAll(".","-") + " "
                                + String(document.querySelector("#operationEndHour").value == "24" ? "00" : document.querySelector("#operationEndHour").value).padStart(2, "0")
                                + ":" + String(document.querySelector("#operationEndMinute").value).padStart(2, "0") + ":00";
                        }

                        if (!document.querySelector("#yearOfEducationPlan").value) {
                            alert('교육 계획 연도는 필수입니다.');
                            return false;
                        } else params.yearOfEducationPlan = document.querySelector("#yearOfEducationPlan").value;

                        if (!document.querySelector("#yearOfEducationPlanStep").value) {
                            alert('기수는 필수입니다.');
                            return false;
                        } else params.yearOfEducationPlanStep = document.querySelector("#yearOfEducationPlanStep").value;

                        if (!document.querySelector("#applyBeginDate").value || !document.querySelector("#applyEndDate").value) {
                            alert('신청기간은 필수입니다.');
                            return false;
                        } else {
                            params.applyBeginDate = document.querySelector("#applyBeginDate").value.replaceAll(".","-");
                            params.applyEndDate = document.querySelector("#applyEndDate").value.replaceAll(".","-");
                        }

                        if (!document.querySelector("#cancelBeginDate").value || !document.querySelector("#cancelEndDate").value) {
                            alert('취소기간은 필수입니다.');
                            return false;
                        } else {
                            params.cancelBeginDate = document.querySelector("#cancelBeginDate").value.replaceAll(".","-");
                            params.cancelEndDate = document.querySelector("#cancelEndDate").value.replaceAll(".","-");
                        }

                        break;
                    case "2": /** 상시 운영*/
                        const today = new Date();
                        const year = today.getFullYear();
                        const month = ('0' + (today.getMonth() + 1)).slice(-2);
                        const day = ('0' + today.getDate()).slice(-2);
                        const hours = ('0' + today.getHours()).slice(-2);
                        const minutes = ('0' + today.getMinutes()).slice(-2);
                        const seconds = ('0' + today.getSeconds()).slice(-2);

                        params.operationBeginDateTime = year + '-' + month  + '-' + day + " " + hours + ':' + minutes  + ':' + seconds;
                        params.operationEndDateTime = "2999-12-31 23:59:59";
                        if (!document.querySelector("#alwaysEducationTerm").value) {
                            alert('수강기한은 필수입니다.');
                            return false;
                        } else params.alwaysEducationTerm = document.querySelector("#alwaysEducationTerm").value;
                        break;
                }
                return true;
            }

            /** 등록 */
            function regist() {
                Array.from($("a[name=button]")).forEach(function (form, index, list) {
                    form.disabled = true;
                });
                /** 필수 값 체크 */
                if (!requiredChk()) return;
                /** 비필수 값 셋팅 */
                /** 교육 타입 */params.educationType="3";
                /** 사용 여부 */params.isUsable = document.querySelector("#isUsable").value;
                /** 과정 코드 */params.curriculumCode = $('input[name=curriculumName]').attr("id");
                /** 담당자 연락처 */params.picTel = document.querySelector("#picTel").value;
                /** 담당자 지점 */params.province = document.querySelector("#province").value;
                /** 상단 고정 여부 */params.isTop =$("input[type=radio][name=isTop]").filter(":checked")[0].value;
                /** 교육과정 등록 */
                $.ajax({ //jquery ajax
                    type:"post", //http method
                    url:"/api/education/schedule/create", //값을 가져올 경로
                    headers: {'Content-Type': 'application/json'},
                    data: JSON.stringify(params),
                    dataType:"json", //html, xml, text, script, json, jsonp 등 다양하게 쓸 수 있음
                    success: function(result) {   //요청 성공시 실행될 메서드
                        if(document.querySelector('#thumbnailFile').files[0]) {
                            var form = new FormData();
                            form.append( "thumbnailFile", document.querySelector('#thumbnailFile').files[0] );
                            $.ajax({
                                type:"put", //http method
                                url:"/api/education/schedule/upload/thumbnailFile/" + result.educationPlanCode, //값을 가져올 경로
                                processData : false,
                                contentType : false,
                                data: form,
                                async:false
                            })
                        }
                        if(fileList.length>0){ //파일첨부API3
                            fileList.forEach((f) => {
                                if(f != null){
                                    let form = new FormData();
                                    form.append( "attachFile", f );
                                    $.ajax({
                                        type:"put", //http method
                                        url:`/api/common/upload/attach/${result.educationPlanCode}?attachType=EDUCATION`, //값을 가져올 경로
                                        processData : false,
                                        contentType : false,
                                        async:false,
                                        data: form,
                                        success: function(data) { },  //요청 성공시 실행될 메서드
                                        error: function(e) {
                                            alert(e.responseJSON.resultMessage);
                                        }
                                    })
                                }
                                if(f == fileList[fileList.length-1]){
                                    alert("교육과정 개설이 완료되었습니다.");
                                    window.location.replace('/education/schedule');
                                }
                            })
                        } else {
                            alert("교육과정 개설이 완료되었습니다.");
                            window.location.replace('/education/schedule');
                        }
                    },
                    error: function(e){		 //요청 실패시 에러 확인을 위함
                        alert(e.responseJSON.resultMessage);
                        Array.from($("a[name=button]")).forEach(function (form, index, list) {
                            form.disabled = false;
                        });
                    }
                })
            }

            /** 수정 */
            function modify() {
                Array.from($("a[name=button]")).forEach(function (form, index, list) {
                    form.disabled = true;
                });
                /** 필수 값 체크 */
                if (!requiredChk()) return;
                /** 교육 타입 */params.educationType="3";
                /** 교육 과정 개설 코드 */params.educationPlanCode = content.educationPlanCode;
                /** 교육 과정 코드 */params.curriculumCode = $('input[name=curriculumName]').attr("id");
                /** 사용 여부 */params.isUsable = document.querySelector("#isUsable").value;
                /** 담당자 연락처 */params.picTel = document.querySelector("#picTel").value;
                /** 담당자 지점 */params.province = document.querySelector("#province").value;
                /** 상단 고정 여부 */params.isTop =$("input[type=radio][name=isTop]").filter(":checked")[0].value;
                /** 비필수 값 셋팅 */

                /** 교육과정 수정 */
                $.ajax({ //jquery ajax
                    type:"put", //http method
                    url:"/api/education/schedule/update", //값을 가져올 경로
                    headers: {'Content-Type': 'application/json'},
                    data: JSON.stringify(params),
                    dataType: "json", //html, xml, text, script, json, jsonp 등 다양하게 쓸 수 있음
                    success: function(result) {   //요청 성공시 실행될 메서드
                        if(document.querySelector('#thumbnailFile').files[0]) {
                            var form = new FormData();
                            form.append( "thumbnailFile", document.querySelector('#thumbnailFile').files[0] );
                            $.ajax({
                                type:"put", //http method
                                url:"/api/education/schedule/upload/thumbnailFile/" + result.educationPlanCode, //값을 가져올 경로
                                processData : false,
                                contentType : false,
                                data: form,
                                success: function(subData) {
                                    window.location.reload();
                                }, error: function(e) {
                                    alert(e.responseJSON.resultMessage);
                                }
                            })
                        }
                        if(fileList.length>0){ //파일첨부API4
                            for (f of fileList){
                                if(f != null){
                                    let form = new FormData();
                                    form.append( "attachFile", f );
                                    $.ajax({
                                        type:"put", //http method
                                        url:`/api/common/upload/attach/${result.educationPlanCode}?attachType=EDUCATION`, //값을 가져올 경로
                                        processData : false,
                                        contentType : false,
                                        async:false,
                                        data: form,
                                        success: function(data) { },  //요청 성공시 실행될 메서드
                                        error: function(e) {
                                            alert(e.responseJSON.resultMessage);
                                        }
                                    })
                                }
                                if(f == fileList[fileList.length-1]){
                                    alert("교육과정 개설 수정이 완료되었습니다.");
                                    window.location.reload();
                                }
                            }
                        } else {
                            alert("교육과정 개설 수정이 완료되었습니다.");
                            window.location.reload();
                        }
                    },
                    error: function(e){		 //요청 실패시 에러 확인을 위함
                        alert(e.responseJSON.resultMessage);
                        Array.from($("a[name=button]")).forEach(function (form, index, list) {
                            form.disabled = false;
                        });
                    }
                })
            }

            //파일첨부API1
            let fileSize = $(".file_size");

            for (var item of fileSize) {
                if(Math.floor(item.innerText / 1024)>1024){
                    let temp = Math.floor(item.innerText / 1024);
                    temp = parseFloat(temp);
                    temp = parseFloat(temp / 1024);
                    temp = temp.toFixed(2);
                    $(item).text(temp+"MB")
                }else{
                    $(item).text(Math.floor(item.innerText / 1024)+"KB")
                }
            };
            var fileList=[];

            $("#formFile").bind("change", function (e){
                if(this.files[0]){
                    fileList.push(this.files[0])

                    //총용량 추가
                    let text = this.files[0].size;
                    text = parseFloat(text) / 1024;
                    text = parseFloat(text) / 1024;
                    text = text.toFixed(2);
                    let now = $('#fileMB').text();
                    now = parseFloat(now)+parseFloat(text);
                    now = parseFloat(now).toFixed(2);
                    $('#fileMB').text(now);
                }
            })

            //파일첨부API2
            $(".file_delete").bind("click", function (e){
                e.preventDefault();
                if(confirm("정말로 파일을 삭제하시겠습니까?")){
                    let CONT = [[ ${content}]];
                    let index = $(this).attr("value")*1 ? $(this).attr("value")*1:0;
                    let url = $(this).attr("href")
                    $.ajax({
                        type: "delete", //http method
                        url: url, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(CONT[0].fileMasters[index]),
                        dataType: "json",
                        success: function(data) {
                            alert("삭제되었습니다.")
                        },
                        error: function(e) {
                            alert("오류가 발생했습니다.")
                        }
                    })
                    //총용량 계산
                    let text= $(this).parent().find('.file_size').text()
                    text = text.replace("KB", "");
                    text =  parseInt(text) / 1024;
                    text = text.toFixed(2);
                    let now = $('#fileMB').text();
                    now = parseFloat(now)-parseFloat(text);
                    now = parseFloat(now).toFixed(2);
                    $('#fileMB').text(now);
                    $(this).parent().parent().remove();
                }
            })

            function findAdminTel() {
                $("input[name=picTel]").prop("readonly", false);
                let adminId = $("input[name=eduPlanPic]").val();
                if (adminId) {
                    $.ajax({ //jquery ajax
                        type:"get", //http method
                        url:"/api/user/admin-user?userId="+adminId, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        dataType: "json", //html, xml, text, script, json, jsonp 등 다양하게 쓸 수 있음
                        success: function(result) {   //요청 성공시 실행될 메서드
                            if (result.content != null && result.pageable.totalElements > 0) {
                                $("input[name=picTel]").prop("readonly", false);
                                // 담당자 이름 및 연락처
                                var userName = result.content[0].userName;
                                var picTel = result.content[0].telNo;
                                if (picTel) {
                                    picTel = picTel.replace(/[^0-9]/g, '')
                                    picTel = picTel.replace(/^(\d{2,3})(\d{3,4})(\d{4})$/, `$1-$2-$3`)
                                    $("input[name=picTel]").val(userName+"("+picTel+")")
                                } else {
                                    $("input[name=picTel]").val(userName+"()")
                                }
                            } else {
                                alert("조회되는 관리자 정보가 없습니다. 과정 관리에서 담당자를 확인해주세요.")
                            }
                        },
                        error: function(e){		 //요청 실패시 에러 확인을 위함
                            alert(e.responseJSON.resultMessage);
                        }
                    })
                } else {
                    alert("과정 관리에서 담당자를 지정해주세요.");
                }
            }
            /* ]]> */
        </script>
    </th:block>
</div>
</body>
</html>
