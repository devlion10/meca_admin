<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/default_layout}">
<body>
<div layout:fragment="content" data-menu="homepage-16">
    <div sec:authorize="isAuthenticated()">
        <div class="title">
            <h2>팝업 관리</h2>
        </div>
        <div class="tableLeftResponsive">

            <table class="tableLeft">
                <colgroup>
                    <col style="width: 200px">
                    <col style="width: auto">
                </colgroup>
                <tbody>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>게시기간</th>
                        <td>
                            <div class="bl_dateRange">
                                <input id="popupStartYmd" type="text" class="el_datePicker sdate" name="popupStartYmd" th:if="${content} == null" cts-required="시작기간을 입력해주세요." placeholder="YYYY-MM-DD" not_null="true" alert_name="시작기간">
                                <input id="popupStartYmd" type="text" class="el_datePicker sdate" name="popupStartYmd" th:unless="${content} == null" th:value="${content[0].popupStartYmd}" cts-required="시작기간을 입력해주세요." placeholder="YYYY-MM-DD" not_null="true" alert_name="시작기간">
                                <span class="blank">~</span>
                                <input id="popupEndYmd" type="text" class="el_datePicker edate" name="popupEndYmd" th:if="${content} == null" cts-required="종료기간을 입력해주세요." placeholder="YYYY-MM-DD" not_null="true" alert_name="종료기간">
                                <input id="popupEndYmd" type="text" class="el_datePicker edate" name="popupEndYmd" th:unless="${content} == null" th:value="${content[0].popupEndYmd}" cts-required="종료기간을 입력해주세요." placeholder="YYYY-MM-DD" not_null="true" alert_name="종료기간">
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>제목</th>
                        <td>
                            <input id="title" type="text" class="hp_w600"  not_null="true" alert_name="팝업 제목" th:if="${content} == null">
                            <input id="title" type="text" class="hp_w600"  not_null="true" alert_name="팝업 제목" th:unless="${content} == null" th:value="${content[0].title}" >
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>팝업시점</th>
                        <td>
                            <select id="popupViewType" class="common_select" th:if="${content} == null">
                                <option value="B">로그인 전부터</option>
                                <option value="A">로그인 후부터</option>
                            </select>
                            <select id="popupViewType" class="common_select" th:unless="${content} == null">
                                <option value="B" th:selected="${content[0].popupViewType == 'B'}">로그인 전부터</option>
                                <option value="A" th:selected="${content[0].popupViewType == 'A'}">로그인 후부터</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>내용</th>
                        <td>
                            <textarea id="contents" name="contents" class="ckeditor" style="width:100%; height:200px" th:if="${content} == null"></textarea>
                            <textarea id="contents" name="contents" class="ckeditor" style="width:100%; height:200px"  th:unless="${content} == null" th:utext="${content[0].contents}"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">팝업 이미지</th>
                        <td>
                            <div class="bl_uploadGrid">
                                <div class="bl_upload js_upload hp_lg_w462">
                                    <input type="text" id="popupImagePath" class="bl_upload_path js_path" readonly th:if="${content} and ${content[0].popupImagePath} == null">
                                    <input type="text" id="popupImagePath" class="bl_upload_path js_path" readonly th:if="${content} and ${content[0].popupImagePath} != null" th:value="${content[0].popupImagePath}">
                                    <input th:unless="${content}" id="popupImagePath" type="text" class="bl_upload_path js_path" readonly>

                                    <label class="btn btnDefault bg-secondary text-white bl_upload_btn">파일선택</label>
                                    <input id="thumbnailFile" type="file" name="file" class="bl_upload_file js_file">
                                </div>
                            </div>
                            <div class="bl_uploadGrid" style="margin-top: 10px;">
                                <div class="bl_upload hp_lg_w462">
                                    <input id="popupLink" type="text" class="hp_w600" th:if="${content} == null" placeholder="이미지에 링크를 추가하려면 입력하세요.">
                                    <input id="popupLink" type="text" class="hp_w600" th:unless="${content} == null" th:value="${content[0].popupLink}" placeholder="이미지에 링크를 추가하려면 입력하세요.">
                                </div>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">창 크기</th>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    가로:
                                    <input id="windowSizeV" type="text" class="hp_w120" th:if="${content == null || (content != null && #strings.isEmpty(content[0].windowSizeV))}">
                                    <input id="windowSizeV" type="text" class="hp_w120" th:if="${content != null && !#strings.isEmpty(content[0].windowSizeV)}" th:value="${content[0].windowSizeV}">
                                    pixels
                                </div>
                                <span class="blank">/</span>
                                <div class="d-flex align-items-center gap-2">
                                    세로:
                                    <input id="windowSizeH" type="text" class="hp_w120" th:if="${content == null || (content != null && #strings.isEmpty(content[0].windowSizeH))}">
                                    <input id="windowSizeH" type="text" class="hp_w120" th:if="${content != null && !#strings.isEmpty(content[0].windowSizeH)}" th:value="${content[0].windowSizeH}">
                                    pixels
                                </div>
                            </div>
                            <p class="guide_text mt-2"><span style="font-weight: 500">default  -</span>가로: 350px / 세로: 177px</p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row">창 위치</th>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="d-flex align-items-center gap-2">
                                    top:
                                    <input id="windowTop" type="text" class="hp_w120" th:if="${content == null || (content != null && #strings.isEmpty(content[0].windowTop))}">
                                    <input id="windowTop" type="text" class="hp_w120" th:if="${content != null && !#strings.isEmpty(content[0].windowTop)}" th:value="${content[0].windowTop}">
                                    pixels
                                </div>
                                <span class="blank">/</span>
                                <div class="d-flex align-items-center gap-2">
                                    left:
                                    <input id="windowLeft" type="text" class="hp_w120" th:if="${content == null || (content != null && #strings.isEmpty(content[0].windowLeft))}">
                                    <input id="windowLeft" type="text" class="hp_w120" th:if="${content != null && !#strings.isEmpty(content[0].windowLeft)}" th:value="${content[0].windowLeft}" >
                                    pixels
                                </div>
                                <div class="btn btnDefault ms-3" onclick="popPreview()">미리보기</div>
                            </div>
                            <p class="guide_text mt-2"><span style="font-weight: 500">default  -</span>top: 0px / left: 0px</p>
                        </td>
                    </tr>
                    <tr>
                        <th scope="row"><span class="el_required">*</span>사용여부</th>
                        <td>
                            <div class="radio_box">
                                <input id="popupUseY" type="radio" name="popupUse" checked th:if="${content} == null">
                                <input id="popupUseY" type="radio" name="popupUse" checked th:unless="${content} == null" th:checked="${content[0].popupStts == 1?true:false}">
                                <label for="popupUseY">
                                    <span></span>
                                    사용
                                </label>
                            </div>
                            <div class="radio_box">
                                <input id="popupUseN" type="radio" name="popupUse" th:if="${content} == null">
                                <input id="popupUseN" type="radio" name="popupUse" th:unless="${content} == null" th:checked="${content[0].popupStts == 0?true:false}">
                                <label for="popupUseN">
                                    <span></span>
                                    미사용
                                </label>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="bl_gridBtns">
            <div class="bl_gridBtns_lft">
                <div class="btn btnDefault btnDelete" th:if="${content != null}" onclick="del()">삭제</div>
            </div>
            <div class="bl_gridBtns_rgt">
                <a class="btn btnDefault btnList" href="/homepage/popup">목록</a>
                <div class="btn btnDefault btnRegister" th:if="${content == null}" onclick="save('create')">등록</div>
                <div class="btn btnDefault btnModify" th:if="${content != null}" onclick="save('update')">수정</div>
            </div>
        </div>
    </div>
    <div sec:authorize="!isAuthenticated()"></div>
    <th:block layout:fragment="script">
        <script th:inline="javascript">
            /* <![CDATA[ */
            function del() {
                if(confirm(`정말로 삭제하시겠습니까?`)){
                    let params = getFormData();
                    $.ajax({ //jquery ajax
                        type:"delete", //http method
                        url:`/api/homepage/popup/delete/${params.popupSn}`, //값을 가져올 경로
                        headers: {'Content-Type': 'application/json'},
                        data: JSON.stringify(params),
                        dataType:"json", //html, xml, text, script, json, jsonp 등 다양하게 쓸 수 있음
                        success: function(data){   //요청 성공시 실행될 메서드
                            alert('삭제되었습니다.');
                            location.href = '/homepage/popup';
                        },
                        error: function(e){		 //요청 실패시 에러 확인을 위함
                            if(e && e.responseJSON && e.responseJSON.resultMessage){
                                alert(e.responseJSON.resultMessage);
                            }else{
                                alert('삭제 중 오류가 발생했습니다.')
                            }
                        }
                    })
                }
            }

            function save(type){
                if(nullCheck()){
                    if (CKEDITOR.instances.contents.getData() == '') {
                        alert('팝업 내용을 입력해주세요.');
                        return;
                    }

                    let params = getFormData()
                    if (type == 'create') {
                        $.ajax({
                            type: "post",
                            headers: {'Content-Type' : 'application/json'},
                            url: "/api/homepage/popup/create",
                            data: JSON.stringify(params),
                            dataType: "json",
                            success: function (data){
                                if(document.querySelector('#thumbnailFile').files[0]) {
                                    var form = new FormData();
                                    form.append( "thumbnailFile", document.querySelector('#thumbnailFile').files[0] );
                                    $.ajax({
                                        type:"put", //http method
                                        url:"/api/homepage/popup/upload/" + data.popupSn, //값을 가져올 경로
                                        processData : false,
                                        contentType : false,
                                        data: form,
                                        success: function(subData) {   //요청 성공시 실행될 메서드
                                            window.location.replace('/homepage/popup');
                                        },
                                        error: function(e) {
                                            alert(e.responseJSON.resultMessage);
                                        }
                                    });
                                } else {
                                    alert("팝업 등록이 완료되었습니다.");
                                    window.location.replace('/homepage/popup');
                                }
                            },
                            error: function (e){
                                alert(e.responseJSON.resultMessage);
                            }
                        })
                    } else {
                        $.ajax({
                            type: "put",
                            headers: {'Content-Type' : 'application/json'},
                            url: "/api/homepage/popup/update",
                            data: JSON.stringify(params),
                            dataType: "json",
                            success: function (data){
                                if(document.querySelector('#thumbnailFile').files[0]) {
                                    var form = new FormData();
                                    form.append( "thumbnailFile", document.querySelector('#thumbnailFile').files[0] );
                                    $.ajax({
                                        type:"put", //http method
                                        url:"/api/homepage/popup/upload/" + data.popupSn, //값을 가져올 경로
                                        processData : false,
                                        contentType : false,
                                        data: form,
                                        success: function(subData) {   //요청 성공시 실행될 메서드
                                            window.location.reload();
                                        },
                                        error: function(e) {
                                            alert(e.responseJSON.resultMessage);
                                        }
                                    });
                                } else {
                                    alert("팝업 수정이 완료되었습니다.");
                                    window.location.reload();
                                }
                            },
                            error: function (e){
                                alert(e.responseJSON.resultMessage);
                            }
                        })
                    }
                }
            }

            function popPreview() {
                new CommonUI.Laypopup({
                    layerId : 'test_layer',
                    title: $('#title').val(),
                    content : CKEDITOR.instances.contents.getData(),
                    img: $('#popupImagePath').val(),
                    link: $('#popupLink').val(),
                    width: Number($('#windowSizeV').val()),
                    height: Number($('#windowSizeH').val()),
                    startTop: Number($('#windowTop').val()),
                    startLeft: Number($('#windowLeft').val()),
                    cache: true
                });
            }

            let CONT = null;

            function getFormData(){
                let params = {};

                params.popupSn='0'
                if(CONT!=null){
                    params.popupSn = CONT[0].popupSn;
                }

                params.title =$("#title").val();
                params.contents =CKEDITOR.instances.contents.getData();
                params.popupViewType =$("#popupViewType").val();
                params.popupStartYmd=$("#popupStartYmd").val();
                params.popupEndYmd=$("#popupEndYmd").val();
                params.popupLink=$("#popupLink").val();
                params.popupImagePath=$("#popupImagePath").val();

                params.windowSizeH =$("#windowSizeH").val();
                params.windowSizeV =$("#windowSizeV").val();
                params.windowTop =$("#windowTop").val();
                params.windowLeft =$("#windowLeft").val();
                params.popupStts=$("#popupUseY").is(":checked")?1:0;
                return params;
            }

            function onLoadSubmit() {
                console.log('commonCode: ', [[ ${commonCode}]])
                CONT = [[ ${content}]]
            }

        </script>
    </th:block>
</div>
</body>
</html>

